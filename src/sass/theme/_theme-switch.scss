@use "sass:map";
@use "../functions" as f;
@use "theme-variables" as vars;

// Core configurations
$theme-switch: (
  transition: (
    fast: 150ms ease,
    default: 300ms ease,
  ),
  scales: (
    hover: 1.05,
    active: 0.97,
    sun: (
      default: 0.4,
      active: 1.1,
    ),
    moon: 0.8,
  ),
  position: (
    top: 1.5rem,
    left: 1.5rem,
  ),
  eclipse: (
    gradient: (
      center: 15%,
      spread: 35%,
      opacity: 0.9,
    ),
  ),
);

// Keyframes for moon phases
@keyframes before-fullmoon {
  0%, 50% { opacity: 1; }
  50.01%, 100% { opacity: 0; }
  0%, 24.99% { background: #04162E; }
  25%, 100% { background: #B5BCC6; }
  0% { box-shadow: inset 0px 0 7px 0px #B5BCC6; }
  24.99% { box-shadow: inset 55px 0 7px 0px #B5BCC6; }
  25% { box-shadow: inset 55px 0 7px 0px #04162E; }
  50%, 100% { box-shadow: inset 0 0 7px 0px #04162E; }
  0%, 50%, 100% { border-radius: 50%; }
  20%, 30% { border-radius: 10% 10% 10% 10% / 50% 50% 50% 50%; }
  25% { border-radius: 0; }
  0%, 24.99% { transform: rotate(0); }
  25%, 50%, 100% { transform: rotate(180deg); }
}

@keyframes after-fullmoon {
  0%, 50% { opacity: 0; }
  50.01%, 100% { opacity: 1; }
  0%, 50%, 74.99% { background: #B5BCC6; }
  75%, 100% { background: #04162E; }
  0%, 50% { box-shadow: inset 0px 0 7px 0px #04162E; }
  74.99% { box-shadow: inset 55px 0 7px 0px #04162E; }
  75% { box-shadow: inset 55px 0 7px 0px #B5BCC6; }
  100% { box-shadow: inset 0 0 7px 0px #B5BCC6; }
  0%, 50%, 100% { border-radius: 50%; }
  70%, 80% { border-radius: 10% 10% 10% 10% / 50% 50% 50% 50%; }
  75% { border-radius: 0; }
  0%, 50%, 74.99% { transform: rotate(0); }
  75%, 100% { transform: rotate(180deg); }
}

$animation-settings: linear 10s infinite;

// Unified mixins
@mixin theme-switch-base {
  --track-width: #{map.get(vars.$screens, "default", "width")};
  --track-height: #{map.get(vars.$screens, "default", "height")};
  --thumb-size: #{map.get(vars.$screens, "default", "thumb")};
  --track-padding: 0.15em;
  --track-inner-space: calc(
    var(--track-width) - var(--thumb-size) - (2 * var(--track-padding))
  );
  --icon-size: var(--thumb-size);
  --icon-position: var(--track-padding);

  appearance: none;
  position: fixed;
  left: map.get($theme-switch, "position", "left");
  top: map.get($theme-switch, "position", "top");
  z-index: var(--z-index-theme-switch);
  cursor: pointer;
  width: var(--track-width);
  height: var(--track-height);
  border-radius: var(--track-height);
  overflow: hidden;
  isolation: isolate;
  backdrop-filter: saturate(4) invert(15%);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: box-shadow 0.3s ease;
}

@mixin icon-common {
  content: "";
  position: absolute;
  width: var(--icon-size);
  height: var(--icon-size);
  background-position: center;
  background-size: 100%;
  background-repeat: no-repeat;
  transform-origin: center;
  will-change: transform, opacity;
  transition: transform map.get($theme-switch, "transition", "default"), filter 0.3s ease;
}

// Component styles
.theme-switch {
  @include theme-switch-base;

  transition: transform map.get($theme-switch, "transition", "fast");

  .switch {
    position: absolute;
    left: var(--track-padding);
    width: var(--thumb-size);
    height: var(--thumb-size);
    transform: translateX(0) rotate(0deg);
    z-index: 2;
    transition: transform map.get($theme-switch, "transition", "default"), box-shadow 0.3s ease, filter 0.3s ease;
    background-image: url("../../assets/images/moon.webp");
    background-size: cover;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

    &:before,
    &:after {
      border-radius: 50%;
      content: "";
      position: absolute;
      top: -4%;
      left: -4%;
      height: 108%;
      width: 108%;
    }

    &:before {
      background: #04162E;
      box-shadow: inset -10px 0 7px 0px #B5BCC6;
      animation: before-fullmoon $animation-settings;
      mix-blend-mode: difference;
    }

    &:after {
      box-shadow: inset -10px 0 7px 0px #B5BCC6;
      animation: after-fullmoon $animation-settings;
      mix-blend-mode: difference;
    }

    &.sun {
      background-image: url("../../assets/images/sun.png");
      filter: grayscale(30%) brightness(1.2);
      box-shadow: 0 0 10px rgba(255, 223, 0, 0.6);
      transform: translateX(0) rotate(360deg);
      &:before,
      &:after {
        animation: none;
        mix-blend-mode: normal;
        opacity: 0; // Hide the pseudo-elements
      }
    }
  }

  // Responsive adjustments
  @each $screen-name, $screen in vars.$screens {
    $breakpoint: map.get($screen, "breakpoint");

    @if $breakpoint {
      @media (max-width: $breakpoint) {
        --track-width: #{map.get($screen, "width")};
        --track-height: #{map.get($screen, "height")};
        --thumb-size: #{map.get($screen, "thumb")};
      }
    }
  }

  // States
  &.light-theme {
    .switch {
      transform: translateX(var(--track-inner-space)) rotate(0deg);
      mix-blend-mode: difference;
      filter: brightness(1.2);
    }
  }

  // Interactive states
  @media (hover: hover) {
    &:hover {
      transform: scale(map.get($theme-switch, "scales", "hover"));
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
  }

  &:active {
    transform: scale(map.get($theme-switch, "scales", "active"));
    transition-duration: 35ms;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  // Touch device optimizations
  @media (pointer: coarse) {
    --track-padding: max(0.2em, 2px);

    &:active {
      transform: scale(0.98);
    }
  }
}

// Add button reset styles
button.theme-switch {
  background: none;
  border: none;
  padding: 0;
  appearance: none;
  display: flex;
  align-items: center;
  justify-content: center;
}
